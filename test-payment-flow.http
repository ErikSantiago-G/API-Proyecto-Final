# Test Payment Flow - E-Commerce Backend

###############################################
# VARIABLES GLOBALES
###############################################

@baseUrl = https://api.saintessence.shop

@adminToken = 
@customerToken =
@categoryId= 
@productId1 = 
@productId2 = 

###############################################
# PASO 1: Crear usuario Admin
###############################################

### 1.1 Registrar Admin (solo la primera vez)
# @name register-admin
POST {{baseUrl}}/auth/register
Content-Type: application/json

{
  "email": "suciosanz@gmail.com",
  "password": "admin123",
  "firstName": "Santiago",
  "lastName": "Garcia",
  "role": "ADMIN"
}

### 1.2 Login Admin
# @name login-admin
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "suciosanz@gmail.com",
  "password": "admin123"
}

###############################################
# PASO 2: Crear Categorías y Productos
###############################################

### 2.1 Crear Categoría
# @name create-category
POST {{baseUrl}}/admin/categories
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "name": "Familias Olfativas Árabes",
  "slug": "perfumes-arabes-familias",
  "description": "Categoría de perfumes árabes organizada por familias olfativas como amaderada, oriental, floral y especiada",
  "isActive": true,
  "imageUrl": "https://perfumescolombia.com.co/cdn/shop/files/lattafa-badee-al-oud-amethyst-original-edp-100ml-6950781.png?v=1751884171"
}
### 2.2 Crear Producto 1 - iPhone
# @name create-product-1
POST {{baseUrl}}/admin/products
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "name": "Lattafa Amethyst",
  "slug": "Lattafa Amethyst",
  "description": "Perfume árabe femenino con notas florales, amaderadas y orientales. Elegante y envolvente, ideal para ocasiones especiales.",
  "price": 100.99,
  "stock": 100,
  "images": [
    "https://perfumescolombia.com.co/cdn/shop/files/lattafa-badee-al-oud-amethyst-original-edp-100ml-6950781.png?v=1751884171",
    "https://attoperfumes.com.co/cdn/shop/files/D3BF9AC6-68E0-4FAA-8AE6-E46EA97ADEA32.jpg?v=1695230241&width=1946"
  ],
  "categoryId": "{{categoryId}}",
  "isActive": true
}

### 2.3 Crear Producto 2 - MacBook
# @name create-product-2
POST {{baseUrl}}/admin/products
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "name": "khamrah lattafa",
  "slug": "khamrah lattafa",
  "description": "Khamrah Lattafa es una fragancia árabe unisex que combina la calidez especiada con un fondo dulce y envolvente.",
  "price": 200,
  "stock": 50,
  "images": [
    "https://fimgs.net/mdimg/perfume/o.75805.jpg"
  ],
  "categoryId": "{{categoryId}}",
  "isActive": true
}

### 2.4 Ver todos los productos
GET {{baseUrl}}/products

###############################################
# PASO 3: Crear Cliente y hacer compra
###############################################

### 3.1 Registrar Cliente (solo la primera vez)
# @name register-customer
POST {{baseUrl}}/auth/register
Content-Type: application/json

{
  "email": "sg1855111@gmail.com",
  "password": "cliente123",
  "firstName": "Juan",
  "lastName": "Pérez"
}

### 3.2 Login Cliente
# @name login-customer
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "sg1855111@gmail.com",
  "password": "cliente123"
}

###############################################
# PASO 4: Agregar productos al carrito
###############################################

### 4.1 Agregar iPhone al carrito (2 unidades)
# @name add-iphone-to-cart
POST {{baseUrl}}/cart
Authorization: Bearer {{customerToken}}
Content-Type: application/json

{
  "productId": "{{productId1}}",
  "quantity": 4
}

### 4.2 Agregar MacBook al carrito (1 unidad)
# @name add-macbook-to-cart
POST {{baseUrl}}/cart
Authorization: Bearer {{customerToken}}
Content-Type: application/json

{
  "productId": "{{productId2}}",
  "quantity": 1
}

### 4.3 Ver carrito
# @name view-cart
GET {{baseUrl}}/cart
Authorization: Bearer {{customerToken}}

###############################################
# PASO 5: CREAR CHECKOUT Y PAGAR
###############################################

### 5.1 Crear sesión de checkout en Stripe
# @name create-checkout
POST {{baseUrl}}/checkout/create
Authorization: Bearer {{customerToken}}
Content-Type: application/json

{
  "shippingAddress": "CR 50#123 SUR CALDAS",
  "successUrl": "https://api.saintessence.shop/success",
  "cancelUrl": "https://api.saintessence.shop/cancel"
}

### IMPORTANTE:
### Copia la URL del campo "url" en la respuesta
### Ábrela en tu navegador
### Usa esta tarjeta de prueba:
###   Número: 4242 4242 4242 4242
###   Fecha: 12/34
###   CVC: 123
###   ZIP: 12345

###############################################
# PASO 6: Verificar resultados
###############################################

### 6.1 Ver órdenes del cliente
GET {{baseUrl}}/orders
Authorization: Bearer {{customerToken}}

### 6.2 Ver carrito (debería estar vacío)
GET {{baseUrl}}/cart
Authorization: Bearer {{customerToken}}

### 6.3 Ver productos (verificar stock reducido)
GET {{baseUrl}}/products

### 6.4 Ver todas las órdenes (Admin)
GET {{baseUrl}}/admin/orders
Authorization: Bearer {{adminToken}}

###############################################
# PASO 7: Actualizar estado de orden (Admin)
###############################################

### 7.1 Actualizar orden a SHIPPED
PATCH {{baseUrl}}/admin/orders/ORDER_ID_AQUI/status
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "status": "SHIPPED"
}

### 7.2 Actualizar orden a DELIVERED
PATCH {{baseUrl}}/admin/orders/ORDER_ID_AQUI/status
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "status": "DELIVERED"
}
